<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>كشف متابعة ورصد درجات الطلاب </title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  
  <style>
    body {
      font-family: 'Traditional Arabic', serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: #333;
      position: relative;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }
    header h1 {
      font-size: 2.7rem;
      color: #1f3c88;
      border-bottom: 3px solid #1f3c88;
      display: inline-block;
      padding: 8px 25px;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-family: 'Traditional Arabic', serif;
    }
    /* زر القائمة فوق يمين */
    #menuBtn {
      position: absolute;
      top: 10px;
      left: 20px; /* بالعربي يمين */
      font-size: 2.2rem;
      cursor: pointer;
      user-select: none;
      color: #1f3c88;
    }
    #menuOptions {
      position: absolute;
      top: 50px;
      left: 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      display: none;
      min-width: 160px;
      z-index: 1000;
    }
    #menuOptions div {
      padding: 10px 15px;
      cursor: pointer;
      font-family: 'Traditional Arabic', serif;
      font-size: 1rem;
    }
    #menuOptions div:hover {
      background-color: #1f3c88;
      color: white;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .student-block {
      margin-bottom: 18px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .top-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .number {
      font-family: 'Traditional Arabic', serif;
      font-size: 1.3rem;
      width: 20px;
      flex-shrink: 0;
    }
    .name-course {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    .name {
      font-weight: bold;
      font-size: 1.6rem;
      color: #1f3c88;
      white-space: normal;
      line-height: 1.2;
      font-family: 'Traditional Arabic', serif;
    }
    .course {
	  font-weight: bold;
      font-family: 'Traditional Arabic', serif;
      font-size: 0.95rem;
      color: #555;
      margin-top: 1px;
      white-space: normal;
      line-height: 1.2;
    }
    .bottom-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: flex-start;
    }
    .bottom-row input[type="text"] {
      width: 65px;
      padding: 6px;
      border: 1px solid #aaa;
      border-radius: 4px;
      text-align: center;
      font-family: 'Traditional Arabic', serif;
      font-size: 1.1rem;
    }
    .submit-btn {
      text-align: center;
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .submit-btn button {
      padding: 12px 25px;
      font-size: 16px;
      background: #1f3c88;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Traditional Arabic', serif;
      transition: background 0.3s ease;
    }
    .submit-btn button:hover {
      background: #16316e;
    }
    @media (max-width: 480px) {
      .bottom-row input[type="text"] {
        width: 60px;
        font-size: 1rem;
      }
      .name {
        font-size: 1.2rem;
      }
      .course {
        font-size: 0.75rem;
      }
      .submit-btn {
        flex-direction: column;
      }
      .submit-btn button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div id="menuBtn">☰</div>
    <h1 id="halqaTitle">حلقة الإمام البخاري</h1>
    <div id="menuOptions">
      <div data-halqa="bukhari">حلقة الإمام البخاري</div>
      <div data-halqa="muslim">حلقة الإمام مسلم</div>
      <div data-halqa="abudawood">حلقة الإمام أبو داود</div>
      <div data-halqa="tirmidhi">حلقة الإمام الترمذي</div>
    </div>
  </header>
  <div class="container" id="formContainer"></div>
  <div class="submit-btn">
    <button onclick="generatePDF()">تصدير PDF</button>
    <button onclick="exportExcel()">تصدير Excel</button>
    <button onclick="sendWhatsApp()">إرسال واتساب</button>
    <button onclick="downloadAsImage()">تحميل كصورة</button>
    <button onclick="saveReportZip()">حفظ التقرير</button>
  </div>

  <script>
    const halqat = {
      bukhari: [
        ["محمد موسى محمد", "المجلد الثاني والثالث من كتاب مختصر الجمع ( مجلدين)"],
        ["عبدالكريم علي عائض آل فردان", "المجلد الثاني والثالث من كتاب مختصر الجمع ( مجلدين)(خطة الطالب فردان)"],
        ["مصطفى محمد بركات", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["مؤمن كريم عامر", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبدالرحمن عبدالعزيز بن طالب", "النصف الأول من كفاية المستقنع"],
        ["منير حمزة الهوساوي", "زوائد السنن على الصحيحين"],
        ["مهاب إيهاب النجار", "بلوغ المرام كاملاً"],
        ["محمد أيت باموس", "بلوغ المرام كاملاً"],
        ["مؤيد محمد علي قاسم", "زاد المستقنع كاملاً"],
        ["عمر بن عبدالعزيز القباني", "بلوغ المرام كاملاً"],
        ["صهيب محمد الحمد", "المفردات مع حفظ المظلل 5 مجلدات"],
        ["عاصم عبدالعزيز", "بلوغ المرام كاملاً"],
        ["علي محمد فوزي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمود جاري", "بلوغ المرام كاملاً"],
        ["احمد عبدالستار عبدالفتاح", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبد الإله فهد عبد الماجد آل ثابت", "عمدة الأحكام كاملاً"],
        ["عزام عبدالباسط السفياني", "عمدة الأحكام كاملاً"],
        ["بشاره بشير البشراوي", "عمدة الأحكام كاملاً"],
        ["محمد سعيد محمد محمود الرباني", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد عبد المومن أحمد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبيدالله إبراهيم عبدالرؤوف", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["إسحاق بلال أيندي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"]
      ],
      muslim: [
        ["حبيب إبراهيم بخاري", "النصف الثاني من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبدالرؤوف إبراهيم عبدالرؤوف", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمود دابري أكينينمي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["احمد محمد المعتز", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبدالله أيوب علي", "المفردات مع حفظ المظلل 5 مجلدات"],
        ["عبدالرحمن مكي موسى", "زوائد السنن على الصحيحين"],
        ["محمد ماهر على خليفة", "زوائد السنن على الصحيحين"],
        ["وليد حسن العامري", "بلوغ المرام كاملاً"],
        ["محمد الحسن محمد عبد الرحمن", "بلوغ المرام كاملاً"],
        ["احمد اياد الصحاف", "بلوغ المرام كاملاً"],
        ["صهيب سعيد آل عبدالعال", "بلوغ المرام كاملاً"],
        ["محمد بن علي الخضيري", "زاد المستقنع كاملاً"],
        ["مصطفى ماجد احمد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["أحمد بن محمد العربي طه", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["مسلم كريم عامر", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["معتز فهد آل ثابت", "عمدة الأحكام كاملاً"],
        ["عمر عبدالعزيز الغامدي", "عمدة الأحكام كاملاً"],
        ["مجاهد ممدوح النفيسي", "عمدة الأحكام كاملاً"],
        ["هاشم مسلم القرشي", "عمدة الأحكام كاملاً"],
        ["أدوتي أحمد أبطئ", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبدالحق أودو لي الإشبيلي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عبدالملك يونس يوسف", "ألفية ابن مالك كاملاً"]
      ],
      abudawood: [
        ["ايهاب علي احمد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["يوسف عبدالرحمن علي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["يوسف محمد سليمان", "بلوغ المرام كاملاً"],
        ["عبدالله الخطيب", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد علي محمد", "المفردات مع حفظ المظلل 5 مجلدات"],
        ["محمد علي أبو بكر", "زوائد السنن على الصحيحين"],
        ["عبد الرحمن ابو بكر ادم", "بلوغ المرام كاملاً"],
        ["خالد بن إبراهيم الناصر", "بلوغ المرام كاملاً"],
        ["يوسف بن ابراهيم الحديثي", "بلوغ المرام كاملاً"],
        ["سعيد موسى بقعان", "عمدة الأحكام كاملاً"],
        ["عبد الحكيم إدريس أولاديميجي", "النصف الأول من كتاب بلوغ المرام"],
        ["محمد عبدالله الغريب", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["أحمد علي الحاج", "ألفية ابن مالك كاملاً"],
        ["معاذ آدم موسى", "ألفية ابن مالك كاملاً"],
        ["عبدالله عبدالقادر", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["يحيى أحمد المحمدي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد يرو عبد", "النصف الأول من كتاب بلوغ المرام"],
        ["مالك حسن السيد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد حسن السيد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["الطاهر عبدالرحمن موسى", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد المصطفى عبدالودود", "ألفية ابن مالك كاملاً"],
        ["عبدالرحمن منصور الغامدي", "زاد المستقنع كاملاً"],
        ["عبدالله أبرهة", "عمدة الأحكام كاملاً"]
      ],
      tirmidhi: [
        ["عبدالحليم معروف خضر", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["إبراهيم بن عبدالعزيز الصوينع", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["أحمد عبد الستار محمد محمد", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["خالد مصطفى السيد الطوبجي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["عاصم محمد أمين", "المفردات مع حفظ المظلل 5 مجلدات"],
        ["محمد يوسف محمد حمزة", "المفردات مع حفظ المظلل 5 مجلدات"],
        ["عبد الرحمن محمد عبدالمتين عثمان", "زوائد السنن على الصحيحين"],
        ["فايز بختيار أحمد", "بلوغ المرام كاملاً"],
        ["أنس بن عبد الرحمن الشدي", "بلوغ المرام كاملاً"],
        ["عبد الرحمن باداود", "بلوغ المرام كاملاً"],
        ["محمود أبكر الهوساوي", "ألفية ابن مالك كاملاً"],
        ["محمد خالد البديوي", "كتاب التوحيد"],
        ["مصطفى ذنون", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["مؤيد محمد عبدالله", "عمدة الأحكام كاملاً"],
        ["أسامة المحمدي", "عمدة الأحكام كاملاً"],
        ["ناهي الجويعد", "عمدة الأحكام كاملاً"],
        ["أحمد إبراهيم الهاشمي", "عمدة الأحكام كاملاً"],
        ["أحمد سيد سعد محمد", "عمدة الأحكام كاملاً"],
        ["محمود جميل علي", "النصف الأول من كتاب مختصر الجمع ( مجلد ونصف)"],
        ["محمد سالم كليب يحيى", "بلوغ المرام كاملاً"],
        ["محمد ريدان توفيق", "ألفية ابن مالك كاملاً"]
      ]
    };

    const container = document.getElementById("formContainer");
    const halqaTitle = document.getElementById("halqaTitle");
    const menuBtn = document.getElementById("menuBtn");
    const menuOptions = document.getElementById("menuOptions");

    function loadHalqa(key) {
      container.innerHTML = "";
      let titleText = "";
      switch(key){
        case "bukhari": titleText = "حلقة الإمام البخاري"; break;
        case "muslim": titleText = "حلقة الإمام مسلم"; break;
        case "abudawood": titleText = "حلقة الإمام أبو داود"; break;
        case "tirmidhi": titleText = "حلقة الإمام الترمذي"; break;
        default: titleText = "حلقة الإمام البخاري";
      }
      halqaTitle.textContent = titleText;

      const studentsList = halqat[key] || [];
      studentsList.forEach((student, index) => {
        const block = document.createElement("div");
        block.className = "student-block";
        block.innerHTML = `
          <div class="top-row">
            <div class="number">${index + 1}</div>
            <div class="name-course">
              <div class="name">${student[0]}</div>
              <div class="course">${student[1]}</div>
            </div>
          </div>
          <div class="bottom-row">
            <input type="text" placeholder="صفحة" maxlength="5" pattern="\\d*" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')" />
            <input type="text" placeholder="حديث" maxlength="5" pattern="\\d*" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')" />
            <input type="text" placeholder="درجة" maxlength="5" pattern="\\d*" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')" />
          </div>
        `;
        container.appendChild(block);
      });
    }

    loadHalqa("bukhari");

    menuBtn.onclick = () => {
      menuOptions.style.display = menuOptions.style.display === "block" ? "none" : "block";
    };

    menuOptions.querySelectorAll("div").forEach(div => {
      div.onclick = () => {
        const key = div.getAttribute("data-halqa");
        loadHalqa(key);
        menuOptions.style.display = "none";
      };
    });

    function gatherData() {
      return Array.from(document.querySelectorAll(".student-block")).map((block, index) => {
        const name = block.querySelector(".name").textContent;
        const course = block.querySelector(".course").textContent;
        const inputs = block.querySelectorAll("input");
        return {
          number: (index + 1),
          name,
          course,
          page: inputs[0].value.trim(),
          hadith: inputs[1].value.trim(),
          grade: inputs[2].value.trim()
        };
      });
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "a4"
      });
      const data = gatherData();

      doc.setFont("Traditional Arabic", "normal");
      doc.setFontSize(16);
      doc.text(halqaTitle.textContent, 40, 40);

      const rows = data.map(d => [
        d.number,
        d.name,
        d.course,
        d.page,
        d.hadith,
        d.grade
      ]);
      doc.autoTable({
        head: [["#", "اسم الطالب", "المقرر", "صفحة", "حديث", "درجة"]],
        body: rows,
        startY: 60,
        styles: {
          font: "Traditional Arabic",
          fontSize: 10,
          cellPadding: 4,
          halign: 'center',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [31, 60, 136]
        }
      });
      doc.save("تقييم_الحلقة.pdf");
    }

    function exportExcel() {
      const data = gatherData();
      const wb = XLSX.utils.book_new();
      const wsData = [
        ["#", "اسم الطالب", "المقرر", "صفحة", "حديث", "درجة"],
        ...data.map(d => [d.number, d.name, d.course, d.page, d.hadith, d.grade])
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "تقييم الحلقة");
      XLSX.writeFile(wb, "تقييم_الحلقة.xlsx");
    }

    function sendWhatsApp() {
      const data = gatherData();
      let text = `${halqaTitle.textContent}:\n\n`;
      data.forEach(d => {
        text += `${d.number}. ${d.name}\n${d.course}\nصفحة: ${d.page}, حديث: ${d.hadith}, درجة: ${d.grade}\n\n`;
      });
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    }

    function downloadAsImage() {
      html2canvas(container, { scale: 2 }).then(canvas => {
        const link = document.createElement("a");
        link.download = "تقييم_الحلقة.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    async function saveReportZip() {
      const zip = new JSZip();
      const data = gatherData();

      // PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "a4"
      });
      doc.setFont("Traditional Arabic", "normal");
      doc.setFontSize(16);
      doc.text(halqaTitle.textContent, 40, 40);
      const rows = data.map(d => [
        d.number,
        d.name,
        d.course,
        d.page,
        d.hadith,
        d.grade
      ]);
      doc.autoTable({
        head: [["#", "اسم الطالب", "المقرر", "صفحة", "حديث", "درجة"]],
        body: rows,
        startY: 60,
        styles: {
          font: "Traditional Arabic",
          fontSize: 10,
          cellPadding: 4,
          halign: 'center',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [31, 60, 136]
        }
      });
      const pdfBlob = doc.output("blob");
      zip.file("تقييم_الحلقة.pdf", pdfBlob);

      // Excel
      const wb = XLSX.utils.book_new();
      const wsData = [
        ["#", "اسم الطالب", "المقرر", "صفحة", "حديث", "درجة"],
        ...data.map(d => [d.number, d.name, d.course, d.page, d.hadith, d.grade])
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "تقييم الحلقة");
      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      zip.file("تقييم_الحلقة.xlsx", wbout);

      // Image
      const canvas = await html2canvas(container, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");
      const imgBlob = await (await fetch(imgData)).blob();
      zip.file("تقييم_الحلقة.png", imgBlob);

      // Generate zip
      zip.generateAsync({ type: "blob" }).then(function(content) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = "تقرير_الحلقة.zip";
        link.click();
      });
    }
  </script>
</body>
</html>
